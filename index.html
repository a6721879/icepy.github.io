<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>行者</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="iOS JavaScript Swift Objective-C 前端 HTML5">
<meta property="og:type" content="website">
<meta property="og:title" content="行者">
<meta property="og:url" content="http://lcepy.github.io/index.html">
<meta property="og:site_name" content="行者">
<meta property="og:description" content="iOS JavaScript Swift Objective-C 前端 HTML5">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="行者">
<meta name="twitter:description" content="iOS JavaScript Swift Objective-C 前端 HTML5">
  
    <link rel="alternative" href="/atom.xml" title="行者" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7qncz5.com1.z0.glb.clouddn.com/blog/mockingbird.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">icepy</a></h1>
		</hgroup>

		
		<p class="header-subtitle">曾记否，到中流击水，浪遏飞舟。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/lcepy" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/u/2455876310" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/JavaScript/" style="font-size: 18px;">JavaScript</a> <a href="/tags/django/" style="font-size: 14px;">django</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/nodejs/" style="font-size: 12px;">nodejs</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/生活/" style="font-size: 16px;">生活</a> <a href="/tags/简历/" style="font-size: 10px;">简历</a> <a href="/tags/经验之谈/" style="font-size: 12px;">经验之谈</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">怅寥廓，问苍茫大地，谁主沉浮？</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">icepy</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://7qncz5.com1.z0.glb.clouddn.com/blog/mockingbird.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">icepy</h1>
			</hgroup>
			
			<p class="header-subtitle">曾记否，到中流击水，浪遏飞舟。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/lcepy" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/2455876310" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-利用AVFoundation实现扫描条码" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/16/利用AVFoundation实现扫描条码/" class="article-date">
  	<time datetime="2015-06-16T09:39:05.000Z" itemprop="datePublished">2015-06-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/16/利用AVFoundation实现扫描条码/">利用AVFoundation实现扫描条码</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>iOS7中添加了一组原生支持扫描的组件，通过AVCaptureMetaDataOutput可以扫描各式各样的QR码，条形码，你所需要做的就是写好UI，并将它设置为AVCaptureSession的输出，再实现相应的协议即可。而且，这玩意可以跟Passbook相结合，有许多潜力可以实现，官方也非常推荐大家使用这个API。</p>
<blockquote>
<p>import AVFoundation</p>
<p>实现 AVCaptureMetadataOutputObjectsDelegate协议</p>
</blockquote>
<p>要实现这个扫描器，首先需要导入AVFoundation框架，这是一个专门处理音频，视频的框架。</p>
<p>创建一个AV设备，使用AVMediaTypeVideo常量</p>
<pre><code>let captureDevice = AVCaptureDevice.<span class="function"><span class="title">defaultDeviceWithMediaType</span><span class="params">(AVMediaTypeVideo)</span></span>
</code></pre><p>然后建立一个输入</p>
<pre><code>let <span class="tag">input</span>:AnyObject! = AVCaptureDeviceInput.<span class="function"><span class="title">deviceInputWithDevice</span><span class="params">(captureDevice, error: &amp;error)</span></span>
</code></pre><p>现在，我们来看一看，最关键的部分，创建输出会话，不过在此之前，我们需要先使用AVCaptureSession创建一个会话，将输入端添加到会话中。</p>
<pre><code><span class="keyword">self</span><span class="variable">.captureSession</span> = <span class="built_in">AVCaptureSession</span>()
<span class="keyword">self</span><span class="variable">.captureSession</span>?<span class="variable">.addInput</span>(input as! <span class="built_in">AVCaptureInput</span>)
</code></pre><p>接着，我们开始使用AVCaptureMetadataOutput创建一个输出端</p>
<pre><code>let captureMetadataOutput = <span class="function"><span class="title">AVCaptureMetadataOutput</span><span class="params">()</span></span>
captureMetadataOutput.<span class="function"><span class="title">setMetadataObjectsDelegate</span><span class="params">(self, queue: dispatch_get_main_queue()</span></span>)
captureMetadataOutput<span class="class">.metadataObjectTypes</span> = [AVMetadataObjectTypeEAN13Code,AVMetadataObjectTypeEAN8Code, AVMetadataObjectTypeCode128Code,AVMetadataObjectTypeQRCode]
</code></pre><p>指定要实现的扫描常量，添加一个协议，GCD可以使用在主线程中，并把它添加到会话中。</p>
<pre><code><span class="tag">self</span><span class="class">.captureSession</span>?<span class="class">.addOutput</span>(<span class="tag">captureMetadataOutput</span>)
</code></pre><p>然后我们还需要使用AVCaptureVideoPreviewLayer创建一个画布，用来显示扫描的展示区域，并添加到当前视图的layer中。</p>
<pre><code><span class="keyword">self</span><span class="variable">.videoPreviewLayer</span> = <span class="built_in">AVCaptureVideoPreviewLayer</span>(session: <span class="keyword">self</span><span class="variable">.captureSession</span>)
<span class="keyword">self</span><span class="variable">.videoPreviewLayer</span>?<span class="variable">.videoGravity</span> = <span class="built_in">AVLayerVideoGravityResizeAspect</span>
<span class="keyword">self</span><span class="variable">.videoPreviewLayer</span>?<span class="variable">.frame</span> = <span class="keyword">self</span><span class="variable">.view</span><span class="variable">.bounds</span>
<span class="keyword">self</span><span class="variable">.view</span><span class="variable">.layer</span><span class="variable">.addSublayer</span>(<span class="keyword">self</span><span class="variable">.videoPreviewLayer</span>)
</code></pre><p>最后启动这个会话</p>
<pre><code><span class="tag">self</span><span class="class">.captureSession</span>?<span class="class">.startRunning</span>()
</code></pre><p>到这里，整个扫描条码的程序就已经准备就绪了，但是如果你还需要获取扫描相应的结果，那么需要实现它的协议，并实现func captureOutput(captureOutput: AVCaptureOutput!, didOutputMetadataObjects metadataObjects: [AnyObject]!, fromConnection connection: AVCaptureConnection!) {} 方法。</p>
<p>metadataObjects是一个AnyObject的数组，在这里，还需要进步的判断，获取第一个元素转化为AVMetadataMachineReadableCodeObject，通过type，可以判断扫描的类型，是二维码，还是条形码，还是其他，而值，则是在AVMetadataMachineReadableCodeObject的stringValue属性。</p>
<pre><code><span class="keyword">let</span> metadata = metadataObjects[<span class="number">0</span>] <span class="keyword">as</span>! AVMetadataMachineReadableCodeObject
<span class="comment">//metadata.type</span>
<span class="comment">//metadata.stringValue</span>
</code></pre><p>扫描的Demo可以查看<a href="https://github.com/lcepy/Mockingbird" target="_blank" rel="external">Mockingbird</a></p>
<h2 id="在Objective-C项目中使用">在Objective-C项目中使用</h2><p>runpath $(inherited)@executable_path/Frameworks</p>
<p>三步走图片，可查</p>
<p><img src="http://7qncz5.com1.z0.glb.clouddn.com/iOS/bridging-header-file.png" alt=""></p>
<p><img src="http://7qncz5.com1.z0.glb.clouddn.com/iOS/defines-module-yes.png" alt=""></p>
<p><img src="http://7qncz5.com1.z0.glb.clouddn.com/iOS/import-swift-file.png" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-上架AppStore的经历" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/27/上架AppStore的经历/" class="article-date">
  	<time datetime="2015-05-27T04:43:22.000Z" itemprop="datePublished">2015-05-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/27/上架AppStore的经历/">上架AppStore的经历</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="开发之前的准备">开发之前的准备</h2><p>关于证书，以及流程，前人已有总结，请阅读</p>
<ul>
<li><a href="http://www.jianshu.com/p/6c75a6e53605" target="_blank" rel="external">iOS App提交指南(一)</a></li>
<li><a href="http://www.jianshu.com/p/c7cf65911bc1?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=mobile_author_hots&amp;utm_source=recommendation" target="_blank" rel="external">iOS App提交指南(二)-协议、税务和银行业务</a></li>
<li><a href="http://mp.weixin.qq.com/s?__biz=MjM5OTM0MzIwMQ==&amp;mid=206718165&amp;idx=3&amp;sn=860ec99f81da19cd3d6faffe6d85083b#rd" target="_blank" rel="external">iOS证书说明和发布内购流程整理</a></li>
</ul>
<h2 id="准备开发">准备开发</h2><ul>
<li>在开发码农周刊应用之前，先写了一份PRD，把需求写清楚，然后利用storyboard画了一个简单的原型。PRD List我用的是<a href="https://trello.com/" target="_blank" rel="external">trello</a></li>
<li>图片资源我统一用Images.xcassets来进行管理</li>
<li><a href="http://pixabay.com/" target="_blank" rel="external">pixabay</a>搜索一些免费的资源</li>
<li><a href="http://makeappicon.com/" target="_blank" rel="external">makeappicon</a>生成app的启动icon</li>
<li><a href="https://icons8.com/" target="_blank" rel="external">icons8</a>下载了一份iOS的icon</li>
<li><a href="https://appscreens.io/" target="_blank" rel="external">appscreens</a>这个工具用于生成需要提交到AppStore审核的预览图片</li>
</ul>
<h2 id="准备提交">准备提交</h2><p>在Build Settings Code Signing中设置 Code Signing Identity和Provisioning Profile，用你在apple申请的发布证书和发布描述，然后把Device选择为真机。</p>
<p><img src="http://websources.qiniudn.com/iOS/codsigning.png" alt=""></p>
<p>选择Product中的Archive构建发布版本，可以直接点击Submit to App Store</p>
<p><img src="http://websources.qiniudn.com/iOS/archives.png" alt=""></p>
<h2 id="构建错误与警告">构建错误与警告</h2><p>在构建发布版本时Xcode会检测发布App所具备的逻辑，下面是我遇到的错误和警告</p>
<p>error itms -90096 : your binary is not optimized for iphone5 new iPhone apps and app updates submitted must support the 4-inch display on iphone5 and must include a launch image with the -568h size modifier immediately following the<basename> portion of the launch images’ filename. launch images must be png files and located at the top level of your bundle or provided within each. lproj folder if you localize your launch images learn more about iPhone 5 support and app launch images by reviewing the ‘iOS Human interface guidelines at</basename></p>
<p>上传启动动画PNG图片，另外还给出了三个解决方案参考的URL</p>
<p><a href="https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/MobileHIG/IconsImages/IconsImages.html" target="_blank" rel="external">参考一</a><a href="https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/MobileHIG/LaunchImages.html#//apple_ref/doc/uid/TP40006556-CH22-SW1" target="_blank" rel="external">参考二</a><a href="https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/MobileHIG/IconMatrix.html#//apple_ref/doc/uid/TP40006556-CH27-SW1" target="_blank" rel="external">参考三</a></p>
<p>error itms-4238 redundant binary upload. there already exists a binary upload with build version ‘1’ for train ‘1.0’ at software assets/prereleasesoftwareasset</p>
<p>因为想要提交的版本已经存在，更改build版本号</p>
<p>error itms-90032: invalid image path - no image found at the path referenced under key CFBundleIconFiles:’xxx</p>
<p>存在一个不使用的配置，在Info中删除</p>
<p>WARNING ITMS:iTunes Store operation succeeded with a warning<br>the app references non-public selectors in Payload/manongweekly.app/manongweekly:addContent</p>
<p>查找是否使用了非公用API，一些名字可能会是私有API，最好把名改了</p>
<p>WARNING ITMS 90025:Missing recommended icon file the bundle does not contain an app icon for iPhone/ipodtouch of exactly ‘120x120’pixels in.png format for iOS versions &gt;=7.0</p>
<p>添加76，76@2x的图标PNG</p>
<h2 id="查看被拒原因与加急">查看被拒原因与加急</h2><p>在<a href="https://developer.apple.com/membercenter/index.action" target="_blank" rel="external">Member Center</a>中应用审核的最下面，有一个解决方案中心，点击解决方案中心，可以查看被拒原因，审核人员会给你罗列以及解决方案参考。</p>
<p>如果应用审核通过了，在使用的过程中发现有重大的bug导致应用crash，可以申请加急，非常快，<a href="https://developer.apple.com/appstore/contact/?topic=expedite%3E" target="_blank" rel="external">contact</a></p>
<p>最后《码农周刊》iOS客户端愉快的上线了</p>
<p><a href="https://itunes.apple.com/cn/app/yuan-yi-yue/id990227579?l=en&amp;mt=8" target="_blank" rel="external"><img src="https://camo.githubusercontent.com/770175f6c01d89c84a020706126a9e6399ff76c4/68747470733a2f2f696d672e736869656c64732e696f2f636f636f61706f64732f702f4b696e676669736865722e7376673f7374796c653d666c6174" alt="AppStore"></a>  <a href="https://github.com/lcepy/manong-reading" target="_blank" rel="external"><img src="https://camo.githubusercontent.com/b0224997019dec4e51d692c722ea9bee2818c837/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f6c6963656e73652f6d6173686170652f6170697374617475732e737667" alt="manong-reading"></a></p>
<p><a href="https://itunes.apple.com/cn/app/yuan-yi-yue/id990227579?l=en&amp;mt=8" target="_blank" rel="external">Download on the App Store</a> </p>
<p><a href="https://github.com/lcepy/manong-reading" target="_blank" rel="external">checking on the manong-reading project </a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-使用storyboard设计app原型" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/23/使用storyboard设计app原型/" class="article-date">
  	<time datetime="2015-05-23T12:48:13.000Z" itemprop="datePublished">2015-05-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/23/使用storyboard设计app原型/">使用storyboard设计app原型</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天我想写一下自己利用storyboard+swift快速设计一款App原型的经历，这是突然发现Xcode的强大之处带来的优势，你可以设计一个如下图的原型。</p>
<p><img src="http://websources.qiniudn.com/iOS/prototype.png" alt=""></p>
<p>先创建一个项目＋创建一个storyboard＋拖拽一个ViewController到storyboard中（默认你知道怎么创建一个项目，怎么新建一个storyboard，以及怎么拖拽一个ViewController到storyboard中）</p>
<p><img src="http://websources.qiniudn.com/iOS/storyboard.png" alt=""></p>
<p>给ViewController设置启动，这个设置针对storyboard是唯一的，也就是只能设置一个</p>
<p><img src="http://websources.qiniudn.com/iOS/initViewController.png" alt=""></p>
<p>给ViewController设置身份ID(identity)，它应该是唯一的，而且后期如果有多个storyboard时场景的跳转会使用到</p>
<pre><code>var <span class="string">sd:</span>UIStoryboard = UIStoryboard(<span class="string">name:</span> <span class="string">"Cycling"</span>, <span class="string">bundle:</span> nil)
var <span class="string">cyc:</span>CyclingInitViewController = sd.instantiateViewControllerWithIdentifier(<span class="string">"CyclingInit"</span>) <span class="keyword">as</span>! CyclingInitViewController
self.navigationController?.pushViewController(cyc, animated: <span class="literal">true</span>)
</code></pre><p><img src="http://websources.qiniudn.com/iOS/identity.png" alt=""></p>
<p>给ViewController应用一个NavgationController，每一个视图控制器中都有一个navigationController和navigationItem。（注意：前者应该算一个公共的，后者navigationItem是每个控制器自身独有的）在使用的时候需要注意这些，以保证标题，以及导航栏上的bar可以设置正确</p>
<p><img src="http://websources.qiniudn.com/iOS/navigationC.png" alt=""></p>
<p>拖拽一个label到视图中，我们可以通过属性板来设置它的一些属性，比如字体大小，颜色，是否居中。属性有很多，基本上和代码中的UILabel可以一一对应起来。</p>
<p><img src="http://websources.qiniudn.com/iOS/attributes.png" alt=""></p>
<p>在Size面板中可以调整x,y以及高宽</p>
<p><img src="http://websources.qiniudn.com/iOS/size.png" alt=""></p>
<p>接下来应该是一个最重要的活儿了，autolayout技术对视图进行约束，这是接下来想对UI进行正确排版所使用的技术，关于它的细节问题，你需要慢慢了解，我只能告诉你怎样在storyboard中利用Xcode给我们提供的工具去连线，去进行约束。</p>
<p>第一种方式，利用右下角的小三角形，对约束进行重置（简单的约束，Xcode非常智能的帮你排版了）</p>
<p><img src="http://websources.qiniudn.com/iOS/constraintsimage.png" alt=""></p>
<p>第二种方式，利用连线去设置constraints，属性比较多，可以记一下，上下左右高宽都有，还有居中什么的</p>
<p><img src="http://websources.qiniudn.com/iOS/constraints3.png" alt=""></p>
<p>第三种方式，利用代码去设置constraints（一般来说，我们是在设计原型，如果用代码…感觉杀鸡焉用牛刀了）推荐一个库<a href="https://github.com/SnapKit/Masonry" target="_blank" rel="external">Masonry</a>（注明：现在还没有swift版的）</p>
<p>最后大家看看我们设计的一个结果吧，源代码可以在Github上查看<a href="https://github.com/lcepy/storyboard-app-prototype" target="_blank" rel="external">storyboard-app-prototype</a></p>
<p><img src="http://websources.qiniudn.com/iOS/result.png" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-使用Worker实现一个多线程数据缓存模块" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/20/使用Worker实现一个多线程数据缓存模块/" class="article-date">
  	<time datetime="2015-05-20T08:24:18.000Z" itemprop="datePublished">2015-05-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/20/使用Worker实现一个多线程数据缓存模块/">使用Worker实现一个多线程数据缓存模块</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Worker是一个可以在后台运行的任务，并提供了一个JavaScript接口让我们来使用它。Worker能够被轻松的创建，还能向它的创建者发送消息。 你只要调用 Worker() 构造函数，指定一个需要运行在 worker 线程内的脚本，就能够很容易的创建一个 worker。</p>
<p>Worker这个API的使用非常的简单</p>
<ul>
<li>postMessage()  向worker内部发送消息</li>
<li>terminate() 立即停止当前的worker</li>
<li>onmessage 一个消息事件，worker内部向前台发送消息 </li>
<li>onerror 一个错误事件，运行环境出错时，worker内部向前台发送消息</li>
</ul>
<p>属性</p>
<ul>
<li>message 一个可读的错误消息</li>
<li>filename 错误所在的文件名</li>
<li>lineno 错误所在的文本行号 </li>
</ul>
<p>JavaScript Client Code</p>
<pre><code><span class="keyword">var</span> workerQueue = [];
<span class="keyword">var</span> cacheSystem = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="keyword">var</span> isWork         = !!Worker;
    <span class="keyword">var</span> dataSource     = {};
    <span class="keyword">var</span> contains     = [];
    <span class="keyword">var</span> lock        = <span class="literal">false</span>;
    <span class="keyword">var</span> count         = <span class="number">0</span>;
    <span class="keyword">var</span> getDash     = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
        <span class="keyword">var</span> dash         = localStorage.getItem(<span class="string">'scanUseDashDataSource'</span>);
        <span class="keyword">var</span> dashData     = dash ? <span class="built_in">JSON</span>.parse(dash).data : contains;
        <span class="keyword">return</span> dashData; 
    }
    <span class="keyword">return</span>    {
        allObject:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
            <span class="keyword">var</span> d = localStorage.getItem(<span class="string">'scanUseModalDataSource'</span>);
            <span class="keyword">return</span> d ? d = <span class="built_in">JSON</span>.parse(d).data : <span class="literal">null</span>;
        },
        objectForKey:<span class="function"><span class="keyword">function</span>(<span class="params">key</span>)</span>{
            <span class="keyword">return</span> <span class="keyword">this</span>.allObject()[key];
        },
        allKeys:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
            <span class="keyword">var</span> o = <span class="keyword">this</span>.allObject();
            <span class="keyword">return</span> o ? <span class="built_in">Object</span>.keys(o) : contains;
        },
        allValues:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
            <span class="keyword">var</span> o = <span class="keyword">this</span>.allObject();
            <span class="keyword">if</span>(!o){
                <span class="keyword">return</span> contains;
            }
            <span class="keyword">var</span> c = [];
            <span class="keyword">for</span>(<span class="keyword">var</span> k <span class="keyword">in</span> o){
                c.push(o[k].data);
            }
            <span class="keyword">return</span> c;
        },
        allDash:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
            <span class="keyword">return</span> getDash();
        },
        setObject:<span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>{
            <span class="keyword">var</span> s             = <span class="keyword">this</span>;
            <span class="keyword">var</span> metadata     = <span class="keyword">this</span>.allObject() || {};
            metadata[value] = {<span class="string">"data"</span>:<span class="literal">null</span>,<span class="string">"work"</span>:<span class="literal">false</span>,<span class="string">"error"</span>:<span class="literal">false</span>};
            <span class="keyword">var</span> dashData     = <span class="keyword">this</span>.allDash();    
            <span class="comment">//如果有网络，提交给后台线程去处理网络请求</span>
            <span class="built_in">window</span>.networkState = <span class="number">1</span>;
            <span class="keyword">if</span>(isWork &amp;&amp; <span class="built_in">window</span>.networkState &gt; <span class="number">0</span>){
                <span class="keyword">var</span> worker = <span class="keyword">new</span> Worker(<span class="string">'fetchThread.js'</span>);
                worker.addEventListener(<span class="string">'message'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">evt</span>)</span>{
                    <span class="built_in">console</span>.log(evt);
                    <span class="keyword">var</span> obj = s.allObject();
                    <span class="keyword">var</span> sp     = evt.data.split(<span class="string">'@icepy-&gt;'</span>);
                    <span class="keyword">var</span> tag = sp[<span class="number">0</span>];
                    <span class="keyword">var</span> dat = sp[<span class="number">1</span>];
                    <span class="keyword">var</span> o   = obj[tag];
                    <span class="keyword">var</span> r   = <span class="built_in">JSON</span>.parse(dat);
                    <span class="keyword">if</span>(o){
                        <span class="comment">//把后台得到的数据添加到data中</span>
                        o.data     = r;
                        <span class="comment">//标记work已经完成</span>
                        o.work  = <span class="literal">true</span>;
                        <span class="comment">//标记执行线程锁</span>
                        lock     = <span class="literal">false</span>;
                        <span class="keyword">if</span>(r.error){
                            o.error = <span class="literal">true</span>;
                        }
                        localStorage.setItem(<span class="string">'scanUseModalDataSource'</span>,<span class="built_in">JSON</span>.stringify({<span class="string">"data"</span>:obj}));
                        workerQueue[count][<span class="number">2</span>] = <span class="literal">true</span>;
                        count++;
                        <span class="keyword">var</span> work = workerQueue[count];
                        <span class="keyword">if</span>(work){
                            <span class="keyword">if</span>(work[<span class="number">2</span>]){
                                <span class="keyword">var</span> i = count++;
                                <span class="keyword">var</span> f = <span class="literal">true</span>;
                                <span class="keyword">do</span>{
                                    <span class="keyword">var</span> _work = workerQueue[i];
                                    <span class="keyword">if</span>(!_work[<span class="number">2</span>]){
                                        _work[<span class="number">1</span>].postMessage(_work[<span class="number">0</span>]);
                                        f = <span class="literal">false</span>;
                                        count = i;
                                        <span class="keyword">break</span>;
                                    }
                                    i++;
                                }<span class="keyword">while</span>(f);
                            }<span class="keyword">else</span>{
                                work[<span class="number">1</span>].postMessage(work[<span class="number">0</span>]);
                            }
                        }<span class="keyword">else</span>{
                            workerQueue.length = <span class="number">0</span>;
                            count = <span class="number">0</span>;
                        }
                    }

                });
                worker.addEventListener(<span class="string">'error'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">evt</span>)</span>{
                    <span class="built_in">console</span>.log(<span class="string">'错误信息处理'</span>);
                });
                <span class="comment">//把线程加入队列</span>
                workerQueue.push([value,worker,<span class="literal">false</span>]);
                <span class="keyword">if</span>(!lock){
                    lock = <span class="literal">true</span>;
                    worker.postMessage(value);
                }
            }
            <span class="keyword">if</span>(!(dashData.indexOf(value) &gt; -<span class="number">1</span>)){
                dashData.push(value);
            }
            localStorage.setItem(<span class="string">'scanUseDashDataSource'</span>,<span class="built_in">JSON</span>.stringify({<span class="string">"data"</span>:dashData}));
            localStorage.setItem(<span class="string">'scanUseModalDataSource'</span>,<span class="built_in">JSON</span>.stringify({<span class="string">"data"</span>:metadata}));
        },
        setValue:<span class="function"><span class="keyword">function</span>(<span class="params">key,value</span>)</span>{
            <span class="keyword">var</span> metadata = <span class="keyword">this</span>.allObject();
            metadata[key].data = value.concat();
            metadata[key].work = <span class="literal">true</span>;
            localStorage.setItem(<span class="string">'scanUseModalDataSource'</span>,<span class="built_in">JSON</span>.stringify({<span class="string">"data"</span>:metadata}));
        },
        removeObjectForKey:<span class="function"><span class="keyword">function</span>(<span class="params">key</span>)</span>{
            <span class="keyword">var</span> metadata     = <span class="keyword">this</span>.allObject();
            <span class="keyword">var</span> dash         = <span class="keyword">this</span>.allDash();
            dash.splice(dash.indexOf(key),<span class="number">1</span>);
            <span class="keyword">this</span>.pop(key);
            <span class="keyword">delete</span> metadata[key];
            localStorage.setItem(<span class="string">'scanUseDashDataSource'</span>,<span class="built_in">JSON</span>.stringify({<span class="string">"data"</span>:dash}));
            localStorage.setItem(<span class="string">'scanUseModalDataSource'</span>,<span class="built_in">JSON</span>.stringify({<span class="string">"data"</span>:metadata}));
        },
        repeat:<span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>{
            <span class="keyword">var</span> d = <span class="keyword">this</span>.allKeys();
                i = <span class="number">0</span>;
            <span class="keyword">if</span>(!d.length){
                <span class="keyword">return</span> <span class="literal">false</span>;
            }<span class="keyword">else</span>{
                <span class="keyword">var</span> lock = <span class="literal">false</span>;
                <span class="keyword">if</span>(d.indexOf(v) &gt; -<span class="number">1</span>){
                    lock = <span class="literal">true</span>;
                }
                <span class="keyword">return</span> lock;
            }
        },
        pop:<span class="function"><span class="keyword">function</span>(<span class="params">key,d</span>)</span>{
            <span class="keyword">if</span>(!d){
                d = <span class="keyword">this</span>.allObject();
            }
            <span class="keyword">if</span>(isWork){
                <span class="keyword">var</span> i = <span class="number">0</span>;
                <span class="keyword">var</span> e = workerQueue.length;
                <span class="keyword">if</span>(e &gt; <span class="number">0</span>){
                    <span class="keyword">for</span>(;i&lt;e;i++){
                        <span class="keyword">var</span> work = workerQueue[i];
                        <span class="keyword">if</span>(work &amp;&amp; work[<span class="number">0</span>] === key){
                            work[<span class="number">2</span>] = <span class="literal">true</span>;
                            work[<span class="number">1</span>].terminate();
                            <span class="keyword">break</span>;
                        }
                    }
                }
            }
        },
        isWork:isWork
    }
}();
</code></pre><p>JavaScript Thread Code</p>
<pre><code>addEventListener<span class="list">(<span class="quoted">'message</span>',function<span class="list">(<span class="keyword">evt</span>)</span>{
    var parameter     = evt.data<span class="comment">;</span>
    var xhr         = new XMLHttpRequest<span class="list">()</span><span class="comment">;</span>
    var headers        = {}<span class="comment">;</span>
    xhr.onreadystatechange = function<span class="list">(<span class="keyword">e</span>)</span>{
           if<span class="list">(<span class="keyword">xhr</span>.readyState === <span class="number">4</span>)</span>{
               clearInterval<span class="list">(<span class="keyword">abortTimeout</span>)</span><span class="comment">;</span>
               if<span class="list">(<span class="list">(<span class="keyword">xhr</span>.status &gt;= <span class="number">200</span> <span class="keyword">&amp;&amp;</span> xhr.status &lt; <span class="number">300</span>)</span> || xhr.status == <span class="number">304</span>)</span>{
                   postMessage<span class="list">(<span class="keyword">parameter+</span>'@icepy-&gt;<span class="quoted">'+xhr</span>.responseText)</span><span class="comment">;</span>
                   close<span class="list">()</span><span class="comment">;</span>
               }
           }
       }
    xhr.open<span class="list">(<span class="quoted">'POST</span>',<span class="quoted">'http</span><span class="keyword">://127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">8001</span>/',true)</span><span class="comment">;</span>
       xhr.send<span class="list">(<span class="keyword">parameter</span>)</span><span class="comment">;</span>
       var abortTimeout = setInterval<span class="list">(<span class="keyword">function</span><span class="list">()</span>{
           xhr.abort<span class="list">()</span><span class="comment">;</span>
           postMessage<span class="list">(<span class="keyword">parameter+</span>'@icepy-&gt;<span class="quoted">'+</span>'{<span class="string">"error"</span>:<span class="string">"timeout"</span>}')</span><span class="comment">;</span>
           close<span class="list">()</span><span class="comment">;</span>
       },<span class="number">1000</span><span class="variable">*13);

       xhr.onerror = function(e){
           postMessage(parameter+'@icepy-&gt;'+'{"error":"notnetwork"}');
           close();
       }     
});</span></span></span>
</code></pre><p>阅读资料</p>
<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Worker" target="_blank" rel="external">https://developer.mozilla.org/zh-CN/docs/Web/API/Worker</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-NSDictionary" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/16/NSDictionary/" class="article-date">
  	<time datetime="2015-05-16T11:20:01.000Z" itemprop="datePublished">2015-05-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/16/NSDictionary/">NSDictionary</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>使用字典，能很好的组织数据，OC中的字典有三种方式</p>
<pre><code><span class="comment">//创建字典</span>
<span class="built_in">NSDictionary</span> *dic = [[<span class="built_in">NSDictionary</span> alloc] initWithObjectsAndKeys:<span class="string">@"value"</span>,<span class="string">@"key"</span>,<span class="string">@"github"</span>,<span class="string">@"build"</span>, <span class="literal">nil</span>];
<span class="built_in">NSDictionary</span> *dic1 = @{<span class="string">@"key1"</span>:<span class="string">@"value1"</span>};
<span class="built_in">NSDictionary</span> *dic2 = [<span class="built_in">NSDictionary</span> dictionaryWithObjectsAndKeys:<span class="string">@"value2"</span>,<span class="string">@"key2"</span>, <span class="literal">nil</span>];
</code></pre><p>包含多少个键值对</p>
<pre><code><span class="comment">//包含多少个键值对</span>
<span class="function">NSLog</span>(<span class="at_rule">@<span class="string">"%zd"</span>,dic.count);</span>
</code></pre><p>通过已知的key名来获取值</p>
<pre><code><span class="comment">//已知key来获取值</span>
NSString *<span class="keyword">value</span> = [dic objectForKey:@<span class="string">"key"</span>];
NSLog(@<span class="string">"%@"</span>,<span class="keyword">value</span>);
</code></pre><p>获取所有的key和获取所有的值</p>
<pre><code><span class="comment">//获取所有的key名或者值，返回一个不可变数组</span>
<span class="built_in">NSArray</span> *keys = [dic allKeys];
<span class="built_in">NSArray</span> *values = [dic allValues];
<span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,keys);
<span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,values);
</code></pre><p>通过一个数组key获取值</p>
<pre><code>NSArray *vals = [dic <span class="string">objectsForKeys:</span>@[@<span class="string">"key"</span>] <span class="string">notFoundMarker:</span>@<span class="string">"not"</span>];
NSLog(@<span class="string">"%@"</span>,vals);
</code></pre><p>遍历</p>
<pre><code><span class="list">[<span class="keyword">dic</span> enumerateKeysAndObjectsUsingBlock:^<span class="list">(<span class="keyword">id</span> key, id obj, BOOL *stop)</span> {
    NSLog<span class="list">(<span class="keyword">@</span><span class="string">"%@"</span>,key)</span><span class="comment">;</span>
    NSLog<span class="list">(<span class="keyword">@</span><span class="string">"%@"</span>,obj)</span><span class="comment">;</span>
}]<span class="comment">;</span></span>
</code></pre><p>排序</p>
<pre><code><span class="built_in">NSArray</span> *kesArray =  [dic keysSortedByValueUsingComparator:^<span class="built_in">NSComparisonResult</span>(<span class="keyword">id</span> obj1, <span class="keyword">id</span> obj2) {
    <span class="built_in">NSString</span> *ke1 = obj1;
    <span class="built_in">NSString</span> *ke2 = obj2;
    <span class="keyword">return</span> [ke1 compare:ke2];
}];
</code></pre><p>过滤</p>
<pre><code><span class="collection">[dic keysOfEntriesPassingTest:&lt;#<span class="comment">^BOOL</span><span class="list">(<span class="keyword">id</span> key, id obj, BOOL *stop)</span>predicate#&gt;]</span><span class="comment">;</span>
</code></pre><p>Mutable版的字典，多了增删的方法</p>
<pre><code><span class="built_in">NSMutableDictionary</span> *dicmutable = [<span class="built_in">NSMutableDictionary</span> dictionaryWithDictionary:dic];
</code></pre><p>添加</p>
<pre><code><span class="list">[<span class="keyword">dicmutable</span> setObject:@<span class="string">"icepy"</span> forKey:@<span class="string">"io"</span>]<span class="comment">;</span>
NSLog<span class="list">(<span class="keyword">@</span><span class="string">"%@"</span>,dicmutable)</span><span class="comment">;</span></span>
</code></pre><p>删除</p>
<pre><code><span class="list">[<span class="keyword">dicmutable</span> removeObjectForKey:@<span class="string">"build"</span>]<span class="comment">;</span>
NSLog<span class="list">(<span class="keyword">@</span><span class="string">"%@"</span>,dicmutable)</span><span class="comment">;</span></span>
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-iOS动画基础" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/10/iOS动画基础/" class="article-date">
  	<time datetime="2015-05-09T17:02:06.000Z" itemprop="datePublished">2015-05-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/10/iOS动画基础/">iOS动画基础</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>貌似在哪个领域里，动画的实现都赋予了软件非常生动的交互，所以我们必须要掌握并学好它。在学习动画之前，首推<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreAnimation_guide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40004514" target="_blank" rel="external">Core Animation Programming Guide</a>核心动画编程指南，去了解一下官方的术语，定义，以及指导，这很有帮助。</p>
<p>顾名思义，动画也就是让我们的view可以动起来，所谓的view实际上都会继承于UIView，而每一个UIView都有一个CALayer对象，它们两个是分开的，分别用于不同的地方。可以看见的是，UIView用于显示，CALayer用于绘制。（注明：CALayer属于QuartzCore框架）</p>
<p>UIView自身（注明：UIView属于UIKit框架）会有描述位置的信息，比如frame，transform。在使用一些比较简单的动画时，我们应该首选考虑的是使用UIView提供的一些方法，去改变frame，transform等属性。</p>
<pre><code><span class="collection">[UIView animateWithDuration:1.6 animations:<span class="comment">^{

}</span>]</span><span class="comment">;</span>
</code></pre><p>对于高度复杂一些的动画，就需要我们对Core Animation整个的熟悉和了解了。这里，我建议先阅读一下<a href="http://objccn.io/issue-12-1/" target="_blank" rel="external">动画理解</a>，把一些概念性的东西了解清楚。比如Core Animation维护的层次结构，什么叫模型层树(model layer tree)，什么叫表现层树(presentation layer tree)，而且你务必要理解，当把动画添加到一个layer的时候，是不直接修改其属性的。</p>
<p>在清楚这些概念性的问题后，你可以去学习一些动画类了，比如CABasicAnimation，CATransform3D，CAKeyframeAnimation,CAAnimationGroup,CAAnimation，另外你务必要记住一点，CAAnimation是这些动画类的鼻祖(它是一个抽象类，不能直接使用)，而且要搞清楚CALayer。</p>
<p>举例一些简单的例子</p>
<p><strong>使用CABasicAnimation</strong></p>
<pre><code>CABasicAnimation *<span class="variable">animation =</span> [CABasicAnimation animation];
animation.<span class="variable">keyPath =</span> @<span class="string">"position.x"</span>;
animation.<span class="variable">duration =</span> <span class="number">1</span>;
animation.<span class="variable">fromValue =</span> @<span class="number">50</span>;
animation.<span class="variable">toValue =</span> @<span class="number">250</span>;
[view.layer addAnimation:animation forKey:@<span class="string">"left"</span>];
</code></pre><p>为了验证动画究竟修改了那个地方的值，我打印了一下view的frame，NSLog(@”%@”,NSStringFromCGRect(view.frame))，这里可以看的出来，view的frame值没有发生改变，而且在模拟器中，动画结束了，view又回到了原来的位置。说明啊，动画的执行和view的渲染是分开的，如果你还不理解，请继续阅读《核心动画编程指南》或者简单的《动画理解》。</p>
<p>如果我们不想动画结束后view回到原来的位置，可以使用</p>
<pre><code>animation.fillMode = kCAFillModeForwards<span class="comment">;</span>
animation.removedOnCompletion = NO<span class="comment">;</span>
</code></pre><p><strong>使用CAKeyframeAnimation</strong></p>
<pre><code>CAKeyframeAnimation *animation = [CAKeyframeAnimation animation]<span class="comment">;</span>
animation.keyPath = @<span class="string">"position.x"</span><span class="comment">;</span>
animation.values = @[<span class="localvars">@0</span>,<span class="localvars">@10</span>,@-<span class="number">10</span>,<span class="localvars">@10</span>,<span class="localvars">@0</span>]<span class="comment">;</span>
animation.keyTimes = @[ <span class="localvars">@0</span>, @(<span class="number">1</span> / <span class="number">6.0</span>), @(<span class="number">3</span> / <span class="number">6.0</span>), @(<span class="number">5</span> / <span class="number">6.0</span>), <span class="localvars">@1</span> ]<span class="comment">;</span>
animation.duration = <span class="number">0.4</span><span class="comment">;</span>
animation.additive = YES<span class="comment">;</span>
[view.layer addAnimation:animation forKey:@<span class="string">"shake"</span>]<span class="comment">;</span>
</code></pre><p><strong>使用CAAnimationGroup</strong></p>
<pre><code>CABasicAnimation *right = <span class="comment">[CABasicAnimation animation]</span>;
right.keyPath = @<span class="string">"position.x"</span>;
right.duration = 1;
right.toValue = @250;
right.timingFunction = <span class="comment">[CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseOut]</span>;

CABasicAnimation *top = <span class="comment">[CABasicAnimation animation]</span>;
top.keyPath = @"position.y";
top.duration = 1;
top.toValue = @10;
right.timingFunction = [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseOut];

CAAnimationGroup *animationsGroup = <span class="comment">[CAAnimationGroup animation]</span>;
animationsGroup.animations = @<span class="comment">[right,top]</span>;
<span class="comment">[view.layer addAnimation:animationsGroup forKey:@"group"]</span>;
</code></pre><p>阅读资料：</p>
<ul>
<li><a href="http://objccn.io/issue-12/" target="_blank" rel="external">#12动画</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/CoreAnimation_framework/index.html#//apple_ref/doc/uid/TP40004513" target="_blank" rel="external">Core Animation Reference Collection</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-CoreData的使用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/05/CoreData的使用/" class="article-date">
  	<time datetime="2015-05-05T02:31:04.000Z" itemprop="datePublished">2015-05-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/05/CoreData的使用/">CoreData的使用</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>CoreData是Cocoa中处理数据，绑定数据的一个框架，如果不靠谱数据的平台一致性（iOS，Android），完全可以使用它替代SQLite。虽然，iOS也有一个C实现的SQLite库，但是语法层面比较琐碎，而且使用的是C函数。如果要使用，大家可以选择使用一个开源的库来替代<a href="https://github.com/ccgus/fmdb" target="_blank" rel="external">Obje-C版</a>和<a href="https://github.com/FahimF/SQLiteDB" target="_blank" rel="external">Swift版</a></p>
<p>从代码层面上来看，要创建一个CoreData实例，需要四个步骤</p>
<ul>
<li>创建数据库文件的物理地址</li>
<li>创建模型托管对象</li>
<li>创建持久化存储调度器</li>
<li>创建上下文</li>
</ul>
<p>正常情况下，上述四个步骤，我们只使用一次，建议惰性加载它</p>
<pre><code>-(<span class="built_in">NSManagedObjectContext</span> *)context
{
    <span class="keyword">if</span> (!_context) {
        <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;
        <span class="comment">//创建db url</span>
        <span class="built_in">NSString</span> *dbPath = [<span class="keyword">self</span><span class="variable">.baseDoc</span> stringByAppendingPathComponent:<span class="string">@"manong.db"</span>];
        <span class="built_in">NSURL</span> *dbUrl = [<span class="built_in">NSURL</span> fileURLWithPath:dbPath];
        <span class="comment">//创建模型托管对象</span>
        <span class="built_in">NSManagedObjectModel</span> *model = [<span class="built_in">NSManagedObjectModel</span> mergedModelFromBundles:<span class="literal">nil</span>];
        <span class="comment">//创建持久化存储调度器</span>
        <span class="built_in">NSPersistentStoreCoordinator</span> *store = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:model];
        [store addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:dbUrl options:<span class="literal">nil</span> error:&amp;error];
        <span class="comment">//创建上下文</span>
        _context = [[<span class="built_in">NSManagedObjectContext</span> alloc] init];
        [_context setPersistentStoreCoordinator:store];
    }
    <span class="keyword">return</span> _context;
}
</code></pre><p>下面给出一张关系图</p>
<p><img src="http://websources.qiniudn.com/iOS/CoreData类关系图.png" alt="CoreData类关系图"></p>
<p>从上述的图中，其实可以看到一些有关系的模块</p>
<ul>
<li>Managed Object Model 用于描述数据模型，这里包括实体，属性，请求等</li>
<li>Managed Object Context 参与对数据对象进行各项操作的上下文</li>
<li>Managed Object 数据对象（用户使用的对象与上下文有关联）</li>
<li>Persistent Store 相当于数据库文件的管理器，处理底层对数据库文件的读取与写入</li>
</ul>
<p><strong>基本上创建一个Managed Object文件不需要自己去手动创建，而且建议Xcode帮助我们创建的model文件不要修改</strong></p>
<p>如果非要自己创建的话，那么继承NSManagedObject类吧</p>
<pre><code><span class="preprocessor">#import <span class="title">&lt;Foundation/Foundation.h&gt;</span></span>
<span class="preprocessor">#import <span class="title">&lt;CoreData/CoreData.h&gt;</span></span>

<span class="class"><span class="keyword">@interface</span> <span class="title">ManongTag</span> : <span class="title">NSManagedObject</span></span>

<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, retain) <span class="built_in">NSNumber</span> * contentCount;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, retain) <span class="built_in">NSString</span> * tagKey;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, retain) <span class="built_in">NSString</span> * tagName;

<span class="keyword">@end</span>
</code></pre><h1 id="下面给出一张实际的操作图，如何使用CoreData。">下面给出一张实际的操作图，如何使用CoreData。</h1><p><img src="http://websources.qiniudn.com/iOS/CoreData操作图形化.jpg" alt="CoreData操作图形化"> </p>
<ul>
<li>首先add Entity添加一个实体</li>
<li>然后在Attributes中添加相应的属性，在Type中选择相应的数据类型</li>
<li>Pelationships可以对实体进行关联，比如ManongTitle实体中关联了一个ManongContent实体</li>
<li>&lt;橘黄色箭头&gt;可以设置多关联，在使用的时候它会是一个NSSet集合</li>
<li>Style可以查看设计图</li>
</ul>
<p>如果想新增一条数据，需要三个步骤才能实现，第一先创建一个实体描述，第二创建一个ManagedObject对象，第三给上下文的save方法发送消息。</p>
<pre><code><span class="built_in">NSEntityDescription</span> *mnTag = [<span class="built_in">NSEntityDescription</span> entityForName:<span class="string">@"ManongTag"</span> inManagedObjectContext:<span class="keyword">self</span><span class="variable">.context</span>];
ManongTag *manongTag = [[ManongTag alloc] initWithEntity:mnTag insertIntoManagedObjectContext:<span class="keyword">self</span><span class="variable">.context</span>];
manongTag<span class="variable">.tagKey</span> = tagKey;
manongTag<span class="variable">.tagName</span> = tagNmae;
<span class="built_in">NSError</span> *error = <span class="literal">nil</span>;
<span class="built_in">BOOL</span> success;
[<span class="keyword">self</span><span class="variable">.context</span> save:&amp;error];
success = error ? <span class="literal">NO</span> : <span class="literal">YES</span>;
</code></pre><p>如果想在实体中查询数据，一般情况下两个步骤，如果是条件查询最少三个步骤，第一创建一个查询请求，第二创建一个谓词对象，第三给上下文的executeFetchRequest方法发送消息。</p>
<pre><code><span class="comment">//查询所有的数据</span>
<span class="built_in">NSFetchRequest</span> *request = [[<span class="built_in">NSFetchRequest</span> alloc] initWithEntityName:<span class="string">@"ManongDigest"</span>];
<span class="built_in">NSArray</span> *arr = [<span class="keyword">self</span><span class="variable">.context</span> executeFetchRequest:request error:&amp;error];

<span class="comment">//条件查询</span>
<span class="built_in">NSFetchRequest</span> *request = [[<span class="built_in">NSFetchRequest</span> alloc] initWithEntityName:@“ManongDigest”];
<span class="built_in">NSPredicate</span> *dicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"%K BEGINSWITH[c] %@"</span>,<span class="string">@"tagName"</span>,<span class="string">@"a"</span>];
<span class="built_in">NSArray</span> *arr = [<span class="keyword">self</span><span class="variable">.context</span> executeFetchRequest:request error:&amp;error];
</code></pre><p>如果想更新某一条数据，正常情况下三个步骤，第一创建一个查询请求，第二修改MangedObject对象的属性，第三给上下文的save方法发送消息。</p>
<pre><code><span class="built_in">NSFetchRequest</span> *request = [[<span class="built_in">NSFetchRequest</span> alloc] initWithEntityName:<span class="string">@"ManongDigest"</span>];
<span class="built_in">NSArray</span> *arr = [<span class="keyword">self</span><span class="variable">.context</span> executeFetchRequest:request error:&amp;error];
<span class="keyword">for</span>(ManongDigest *digest <span class="keyword">in</span> arr)
{
    digest<span class="variable">.tagName</span> = <span class="string">@"lcepy"</span>;
}
<span class="built_in">NSError</span> *error = <span class="literal">nil</span>;
[<span class="keyword">self</span><span class="variable">.context</span> save:&amp;error];
<span class="keyword">if</span> (error) {
    <span class="keyword">return</span> <span class="literal">NO</span>;
}<span class="keyword">else</span>{
    <span class="keyword">return</span> <span class="literal">YES</span>;
}
</code></pre><p>如果想删除某一条数据</p>
<pre><code><span class="built_in">NSFetchRequest</span> *request = [[<span class="built_in">NSFetchRequest</span> alloc] initWithEntityName:<span class="string">@"ManongDigest"</span>];
<span class="built_in">NSArray</span> *arr = [<span class="keyword">self</span><span class="variable">.context</span> executeFetchRequest:request error:&amp;error];
<span class="keyword">if</span>(arr<span class="variable">.count</span>){
    ManongDigest *digest = (ManongDigest *)arr[<span class="number">0</span>];
    [<span class="keyword">self</span><span class="variable">.context</span> deleteObject:digest];
}
</code></pre><p>上述四种操作方式是最常用的，当然CoreData 的API肯定不止这四种，但是使用的逻辑思维基本上是，查询－处理－使用上下文或者创建实体－处理－使用上下文。</p>
<p>这个框架算比较复杂的一个，学习起来曲线也比较大，需要耐心。</p>
<p>参考资料</p>
<ul>
<li><a href="http://www.objc.io/issue-4/" target="_blank" rel="external">objc-CoreData</a></li>
<li><a href="http://objccn.io/issue-4-2/" target="_blank" rel="external">一个完整的 Core Data 应用</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/CoreData_ObjC/index.html" target="_blank" rel="external">Core Data API</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSPredicate_Class/" target="_blank" rel="external">NSPredicate API</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-NSArray" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/03/NSArray/" class="article-date">
  	<time datetime="2015-05-03T07:42:06.000Z" itemprop="datePublished">2015-05-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/03/NSArray/">NSArray</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>基础扎实才能使编程更加的得心应手，今天要写一些学习NSArray以及NSMutableArray的东西。</p>
<p>创建一个数组其实跟创建NSString一样OC也提供了三种方式，语法糖，实例化，类方法。</p>
<pre><code><span class="comment">//创建语法糖</span>
<span class="built_in">NSArray</span> *arry = @[<span class="string">@"1"</span>,<span class="string">@"2"</span>,<span class="string">@"3"</span>,<span class="string">@"4"</span>];
<span class="comment">//手动实例创建</span>
<span class="built_in">NSArray</span> *arry1 = [[<span class="built_in">NSArray</span> alloc] initWithObjects:<span class="string">@"1"</span>,<span class="string">@"2"</span>, <span class="literal">nil</span>];
<span class="comment">//类方法创建</span>
<span class="built_in">NSArray</span> *arry2 = [<span class="built_in">NSArray</span> arrayWithObjects:<span class="string">@"1"</span>,<span class="string">@"2"</span>, <span class="literal">nil</span>];
</code></pre><p>查找一个元素在数组中是否存在</p>
<pre><code><span class="comment">//查找元素是否存在，在数组中</span>
BOOL isTrue = [arry <span class="string">containsObject:</span>@<span class="string">"1"</span>];
</code></pre><p>获取数组的长度</p>
<pre><code><span class="comment">//数组的长度</span>
NSUInteger <span class="keyword">count</span> = arry.<span class="keyword">count</span>;
NSLog(@<span class="string">"%zd"</span>,<span class="keyword">count</span>);
</code></pre><p>获取第一个元素和获取最后一个元素</p>
<pre><code><span class="comment">//获取第一个元素</span>
<span class="keyword">id</span> first = arry<span class="variable">.firstObject</span>;
<span class="comment">//获取最后一个元素</span>
<span class="keyword">id</span> last = arry<span class="variable">.lastObject</span>;
</code></pre><p>查找元素在数组中的位置，还可以指定一个range来确定查找的范围</p>
<pre><code><span class="comment">//查找元素在数组中的位置</span>
<span class="built_in">NSInteger</span> index = [arry indexOfObject:<span class="string">@"1"</span>];
<span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>,index);

<span class="comment">//查找元素的位置，可以指定一个range</span>
<span class="built_in">NSRange</span> arrRange = <span class="built_in">NSMakeRange</span>(<span class="number">1</span>, <span class="number">2</span>);
<span class="built_in">NSInteger</span> rangeIndex = [arry indexOfObject:<span class="string">@"3"</span> inRange:arrRange];
<span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>,rangeIndex);
</code></pre><p>指定一个下标来获取元素</p>
<pre><code><span class="comment">//指定一个下标获取元素</span>
<span class="keyword">id</span> element = [arry objectAtIndex:<span class="number">1</span>];
<span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,element);
</code></pre><p>添加一个元素<strong>注意 NSArray是不可变的，所以添加的元素不是旧数组，而是创建了一个包含旧数组的新数组</strong>，还可以添加一个数组</p>
<pre><code><span class="comment">//添加一个元素，返回一个新的数组</span>
NSArray *lcepy = [arry <span class="string">arrayByAddingObject:</span>@<span class="string">"lcepy"</span>];
<span class="comment">//添加一个数组，返回一个新的数组</span>
NSArray *newLcepy = [arry <span class="string">arrayByAddingObjectsFromArray:</span>@[@<span class="string">"lcepy"</span>,@<span class="string">"github.io"</span>]];
</code></pre><p>格式化一个数组</p>
<pre><code><span class="comment">//通过一个分隔字符串来组建一个拼接字符串</span>
<span class="built_in">NSString</span> *ress =  [newLcepy componentsJoinedByString:<span class="string">@"."</span>];
<span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,ress);
</code></pre><p>除了for循环，for in循环外的其它几种常用的遍历方式</p>
<pre><code><span class="comment">//NSEnumerator是一个抽象类，可以使用它的nextObject来遍历元素，通常和while一起使用</span>
<span class="built_in">NSEnumerator</span> *enumer =  [newLcepy objectEnumerator];
<span class="built_in">BOOL</span> isEnumer = <span class="literal">YES</span>;
<span class="keyword">while</span> (isEnumer) {
    <span class="keyword">id</span> enumerValue = [enumer nextObject];
    <span class="keyword">if</span> (!enumerValue) {
        isEnumer = <span class="literal">NO</span>;
    }
    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,enumerValue);
}

[arrays enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) {
    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,obj);
    <span class="keyword">if</span> (idx &gt; <span class="number">3</span>) {
        *stop = <span class="literal">YES</span>;
    }
}];
</code></pre><p>假设如果数组中的元素都想向某个方法发送消息，那么可以这么使用，这样的方式，比如在想移除所有子视图这样的场景中非常好用</p>
<pre><code><span class="comment">//假设有一个数组中的元素都想向某个方法发送消息，那么可以使用makeObjectsPerformSelector类定义了</span>
[newLcepy <span class="string">makeObjectsPerformSelector:</span><span class="annotation">@selector</span>(length)];
</code></pre><p>给数组排序的几种方式</p>
<pre><code><span class="comment">//排序</span>
<span class="built_in">NSArray</span> *arrays = @[@<span class="number">1</span>,@<span class="number">2</span>,@<span class="number">0</span>,@<span class="number">8</span>,@<span class="number">3</span>,@<span class="number">9</span>,@<span class="number">5</span>];

<span class="comment">//正</span>
<span class="built_in">NSArray</span> *minMax = [arrays sortedArrayUsingComparator:^<span class="built_in">NSComparisonResult</span>(<span class="keyword">id</span> obj1, <span class="keyword">id</span> obj2) {
    <span class="keyword">return</span> obj1 &gt; obj2;
}];
<span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,minMax);
<span class="comment">//倒</span>
<span class="built_in">NSArray</span> *maxMin = [arrays sortedArrayUsingComparator:^<span class="built_in">NSComparisonResult</span>(<span class="keyword">id</span> obj1, <span class="keyword">id</span> obj2) {
    <span class="keyword">return</span> obj1 &lt; obj2;
}];
<span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,maxMin);

<span class="comment">//    [arrays sortedArrayWithOptions:&lt;#(NSSortOptions)#&gt; usingComparator:&lt;#^NSComparisonResult(id obj1, id obj2)cmptr#&gt;]</span>

<span class="comment">//    [arrays sortedArrayUsingFunction:&lt;#(NSInteger (*)(__strong id, __strong id, void *))#&gt; context:&lt;#(void *)#&gt;]</span>

SEL execu = <span class="keyword">@selector</span>(compare:);
<span class="built_in">NSArray</span> *newArr = [arrays sortedArrayUsingSelector:execu];
<span class="built_in">NSLog</span>(<span class="string">@"s%@"</span>,newArr);
</code></pre><p>数组还可以进行筛选，NSPredicate这个类在使用Core Data时会经常用到</p>
<pre><code><span class="collection">[arrays filteredArrayUsingPredicate:&lt;#<span class="list">(<span class="keyword">NSPredicate</span> *)</span>#&gt;]</span>
</code></pre><h3 id="NSMutableArray">NSMutableArray</h3><p>创建NSMutableArray只有两种方式，alloc和类方法，这是一个可变的数组，可以增删改滴，也可以排序，NSArray存在的方法，NSMutableArray全部具备，只是它多了可以添加，删除，修改，替换的方法，这里不一一写例子了，可以自己实际操作一下。</p>
<pre><code><span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">addObject</span>:<span class="value">(id)anObject</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">insertObject</span>:<span class="value">(id)anObject atIndex:(NSUInteger)index</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="tag">removeLastObject</span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">removeObjectAtIndex</span>:<span class="value">(NSUInteger)index</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">replaceObjectAtIndex</span>:<span class="value">(NSUInteger)index withObject:(id)anObject</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">addObjectsFromArray</span>:<span class="value">(NSArray *)otherArray</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">exchangeObjectAtIndex</span>:<span class="value">(NSUInteger)idx1 withObjectAtIndex:(NSUInteger)idx2</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="tag">removeAllObjects</span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">removeObject</span>:<span class="value">(id)anObject inRange:(NSRange)range</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">removeObject</span>:<span class="value">(id)anObject</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">removeObjectIdenticalTo</span>:<span class="value">(id)anObject inRange:(NSRange)range</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">removeObjectIdenticalTo</span>:<span class="value">(id)anObject</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">removeObjectsFromIndices</span>:<span class="value">(NSUInteger *)indices numIndices:(NSUInteger)cnt <span class="function">NS_DEPRECATED</span>(<span class="number">10</span>_0, <span class="number">10</span>_6, <span class="number">2</span>_0, <span class="number">4</span>_0)</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">removeObjectsInArray</span>:<span class="value">(NSArray *)otherArray</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">removeObjectsInRange</span>:<span class="value">(NSRange)range</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">replaceObjectsInRange</span>:<span class="value">(NSRange)range withObjectsFromArray:(NSArray *)otherArray range:(NSRange)otherRange</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">replaceObjectsInRange</span>:<span class="value">(NSRange)range withObjectsFromArray:(NSArray *)otherArray</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">setArray</span>:<span class="value">(NSArray *)otherArray</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">sortUsingFunction</span>:<span class="value">(NSInteger (*)(id, id, void *))compare context:(void *)context</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">sortUsingSelector</span>:<span class="value">(SEL)comparator</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">insertObjects</span>:<span class="value">(NSArray *)objects atIndexes:(NSIndexSet *)indexes</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">removeObjectsAtIndexes</span>:<span class="value">(NSIndexSet *)indexes</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">replaceObjectsAtIndexes</span>:<span class="value">(NSIndexSet *)indexes withObjects:(NSArray *)objects</span></span>;

<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">setObject</span>:<span class="value">(id)obj atIndexedSubscript:(NSUInteger)idx <span class="function">NS_AVAILABLE</span>(<span class="number">10</span>_8, <span class="number">6</span>_0)</span></span>;

<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">sortUsingComparator</span>:<span class="value">(NSComparator)cmptr <span class="function">NS_AVAILABLE</span>(<span class="number">10</span>_6, <span class="number">4</span>_0)</span></span>;
<span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">sortWithOptions</span>:<span class="value">(NSSortOptions)opts usingComparator:(NSComparator)cmptr <span class="function">NS_AVAILABLE</span>(<span class="number">10</span>_6, <span class="number">4</span>_0)</span></span>;
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-好用的WebKit-framework" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/01/好用的WebKit-framework/" class="article-date">
  	<time datetime="2015-05-01T06:25:36.000Z" itemprop="datePublished">2015-05-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/01/好用的WebKit-framework/">好用的WebKit.framework</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>WebKit是iOS8推出的一个用于替代UIWebView的框架，解决了很多UIWebView的问题，比如释放内存，各种稀奇古怪的bug，而且还内置了手势的处理，一句话：好用。</p>
<p>注意：<strong>2015年4月更新的苹果审核文档中明确标识，必须要用WebKit替换UIWebView，不然审核拒绝。</strong></p>
<p>在使用WebKit框架的过程中，自己也遇到了一些问题，有些解决了，有些还未解决。</p>
<ul>
<li>WebKit目前还未能在storyboard中直接使用，需要用代码的方式创建，手动添加约束</li>
<li>对于某些页面如果设置了overflow-x，这可能引起scrollView的contentSize的变化，进一步影响WKWebView的内置手势，swipe返回失效</li>
<li>目前还未找到怎么处理NSURLCache的问题，也就是页面的缓存机制，看样子好像要自己实现</li>
</ul>
<p>如何创建一个WKWebView？首先要在link中引入WebKit.framework，然后使用代码的方式：</p>
<pre><code>-(<span class="constant">WKWebView</span> *)<span class="constant">WKWebPageView</span>
{
    <span class="keyword">if</span> (!_WKWebPageView) {
        _WKWebPageView = [[<span class="constant">WKWebView</span> alloc] <span class="symbol">initWithFrame:</span><span class="keyword">self</span>.view.bounds];
        _WKWebPageView.navigationDelegate = <span class="keyword">self</span>;
    }
    <span class="keyword">return</span> _WKWebPageView;
}
</code></pre><p>WKWebView主要需要实现两个协议WKNavigationDelegate和WKUIDelegate，前一个用于一个页面的加载状态，包括第一次响应成功，加载中，加载完成，加载错误等，后面一个我个人感觉有点意思，主要用于改变UI界面，比如客户端JavaScript使用了一个alert，这个协议可以捕获到，然后使用原生的控件来替代。</p>
<p>WebKit框架还提供了一个任务配置类WKWebViewConfiguration，跟NSURLSessionConfiguration的使用方式类似,可以重新初始化WKWebView的一些配置。</p>
<p>WKNavigationDelegate协议，我主要使用了三个来处理我的应用，加载中，加载完成，加载错误的处理：</p>
<pre><code><span class="tag">-</span>(void)<span class="tag">webView</span>:(WKWebView *)<span class="tag">webView</span> <span class="tag">didStartProvisionalNavigation</span>:(WKNavigation *)<span class="tag">navigation</span>
{

}

<span class="tag">-</span>(void)<span class="tag">webView</span>:(WKWebView *)<span class="tag">webView</span> <span class="tag">didFinishNavigation</span>:(WKNavigation *)<span class="tag">navigation</span>
{

}

<span class="tag">-</span>(void)<span class="tag">webView</span>:(WKWebView *)<span class="tag">webView</span> <span class="tag">didFailProvisionalNavigation</span>:(WKNavigation *)<span class="tag">navigation</span> <span class="tag">withError</span>:(NSError *)<span class="tag">error</span>
{

}
</code></pre><p>另外一些属性我用KVO来监听：</p>
<pre><code>[self.WKWebPageView <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"estimatedProgress"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>nil];
[self.WKWebPageView <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"title"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>nil];
[self.WKWebPageView <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"URL"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>nil];
[self.WKWebPageView <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"canGoBack"</span> <span class="string">options:</span>NSKeyValueObservingOptionNew <span class="string">context:</span>nil];
</code></pre><p>它们分别是，页面的加载进度，页面的标题，页面的URL，页面是否回退过</p>
<p>WKWebView默认是没有开启内置手势的，可以通过allowsBackForwardNavigationGestures来设置</p>
<p>与JavaScript的交互，我目前主要使用[self.WKWebPageView evaluateJavaScript:&lt;#(NSString <em>)#&gt; completionHandler:&lt;#^(id, NSError </em>)completionHandler#&gt;]来动态改变页面加载完成之后的css样式，还有WKUserScript <em>script = [[WKUserScript alloc] initWithSource:&lt;#(NSString </em>)#&gt; injectionTime:&lt;#(WKUserScriptInjectionTime)#&gt; forMainFrameOnly:&lt;#(BOOL)#&gt;]来创建脚本，它可以明确指定加载前后注入的方式。</p>
<p><strong>注明：上述的两种创建脚本的方式都是单方向的</strong></p>
<p>如果我们想互相调用，那么就要实现WKScriptMessageHandler协议了，具体的使用方式可以参考下面给出的的参考资料。</p>
<p>参考资料：</p>
<ul>
<li><a href="http://nshipster.cn/wkwebkit/" target="_blank" rel="external">WKWebView-NSHipster</a></li>
<li><a href="https://developer.apple.com/library/prerelease/ios/documentation/WebKit/Reference/WKScriptMessageHandler_Ref/index.html" target="_blank" rel="external">WKScriptMessageHandler</a></li>
<li><a href="https://developer.apple.com/library/prerelease/ios/documentation/WebKit/Reference/WKWebView_Ref/index.html" target="_blank" rel="external">WKWebView</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/WebKit/Reference/WKWebViewConfiguration_Ref/index.html" target="_blank" rel="external">WKWebViewConfiguration</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/WebKit/Reference/WKUIDelegate_Ref/index.html" target="_blank" rel="external">WKUIDelegate</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/WebKit/Reference/WKNavigationDelegate_Ref/index.html" target="_blank" rel="external">WKNavigationDelegate</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-iOS的网络编程NSURL" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/04/22/iOS的网络编程NSURL/" class="article-date">
  	<time datetime="2015-04-22T04:37:14.000Z" itemprop="datePublished">2015-04-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/22/iOS的网络编程NSURL/">iOS的网络编程NSURL</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>如果只是说iOS中的URL系统，它的东西还不算比较多。但是，如果想用好它，可能还需要具备一些其他方面的知识，特别是多任务编程，比如GCD，NSOperation，NSOperationQueue，NSURLSession等等，而且苹果公司在后期还推了一个叫NSURLComponents的东西，这也是需要去学习的。</p>
<p>一个简单的URL是这样发送出去的：</p>
<pre><code><span class="built_in">NSString</span> *path = <span class="string">@"http://lcepy.github.io"</span>;
<span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:path];
<span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:url];
<span class="built_in">NSURLResponse</span> *response = <span class="literal">nil</span>;
<span class="built_in">NSError</span> *error = <span class="literal">nil</span>;
[<span class="built_in">NSURLConnection</span> sendSynchronousRequest:request returningResponse:&amp;response error:&amp;error];
</code></pre><p>基本上如果要构造一个request需要先构造一个NSURL对象，然后通过NSURLConnection发送出去。NSURLRequest是一个不可变的对象，默认发送的是GET的请求，如果想要发送POST请求，可以用它可变的NSMutableURLRequest来支持POST请求，包括超时时间等等。</p>
<p>关于NSURLConnection有三种方式可以发送请求，前面同步版本我们已经看过了，下面是异步和使用协议的方式：</p>
<pre><code>[<span class="built_in">NSURLConnection</span> sendAsynchronousRequest:request queue:<span class="literal">nil</span> completionHandler:^(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *connectionError) {

}];
</code></pre><p>协议：</p>
<pre><code><span class="comment">//实现NSURLConnectionDataDelegate协议</span>

<span class="built_in">NSURLConnection</span> *connection = [<span class="built_in">NSURLConnection</span> connectionWithRequest:request delegate:<span class="keyword">self</span>];
[connection start];

<span class="comment">//常用的需要实现下面四种方法</span>

-(<span class="keyword">void</span>)connection:(<span class="built_in">NSURLConnection</span> *)connection didFailWithError:(<span class="built_in">NSError</span> *)error
{
    <span class="comment">//请求超时，错误的时候</span>
}

-(<span class="keyword">void</span>)connection:(<span class="built_in">NSURLConnection</span> *)connection didReceiveResponse:(<span class="built_in">NSURLResponse</span> *)response
{
    <span class="comment">//服务器第一次响应一个response的时候</span>
}

-(<span class="keyword">void</span>)connection:(<span class="built_in">NSURLConnection</span> *)connection didReceiveData:(<span class="built_in">NSData</span> *)data
{
    <span class="comment">//传输数据</span>
}

-(<span class="keyword">void</span>)connectionDidFinishLoading:(<span class="built_in">NSURLConnection</span> *)connection
{
    <span class="comment">//完成的时候</span>
}
</code></pre><p>对于某些任务，比如下载图片，文件等等大数据的时候，可以使用一个临时会话来启动一个请求，也就是构造一个NSURLSession。</p>
<pre><code><span class="built_in">NSURLSessionConfiguration</span> *configuration = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];
<span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:configuration];
<span class="built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error) {

    <span class="comment">//请求的结果</span>
}];
[task resume];
</code></pre><p>临时会话的好处是每一个都不是在主线程执行，写的代码量比较少，适合简单的任务。</p>
<p><strong>参考资料</strong></p>
<ul>
<li><a href="http://nshipster.cn/nsurl/" target="_blank" rel="external">NSURL/NSURLComponents</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSURLRequest_Class/" target="_blank" rel="external">NSURLRequest</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSURL_Class/index.html" target="_blank" rel="external">NSURL</a></li>
<li><a href="https://developer.apple.com/library/prerelease/ios/documentation/Cocoa/Reference/Foundation/Classes/NSURLConnection_Class/index.html" target="_blank" rel="external">NSURLConnection</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSession_class/" target="_blank" rel="external">NSURLSession</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSURLResponse_Class/index.html" target="_blank" rel="external">NSURLResponse</a></li>
<li><a href="http://objccn.io/issue-5-4/" target="_blank" rel="external">从 NSURLConnection 到 NSURLSession</a></li>
<li><a href="http://ubluesky.com/archives/55" target="_blank" rel="external">NSURL详解</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 icepy
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>